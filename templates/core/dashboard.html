{% extends 'base.html' %}
{% load jalali_tags %}

{% block content %}

<div class="card-clean p-4 mb-4">
    <h5 class="mb-3">آپلود فایل جدید</h5>

    <form id="upload-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mb-3">
            <label class="form-label">عنوان (اختیاری)</label>
            <input type="text" class="form-control" name="title" id="title">
        </div>

        <div class="mb-3">
            <label class="form-label">فایل صوتی</label>
            <input class="form-control" type="file" name="audio_file" id="audio-file" required>
        </div>

        <div class="mb-3">
            <label class="form-label d-block">انتخاب مدل پردازش</label>

            <div class="form-check">
                <input class="form-check-input" type="radio" name="model_name" id="model-eboo" value="eboo" checked required>
                <label class="form-check-label" for="model-eboo">
                    Eboo
                </label>
            </div>

            <div class="form-check">
                <input class="form-check-input" type="radio" name="model_name" id="model-vira" value="vira">
                <label class="form-check-label" for="model-vira">
                    Vira
                </label>
            </div>

            <div class="form-check">
                <input class="form-check-input" type="radio" name="model_name" id="model-scribe" value="scribe">
                <label class="form-check-label" for="model-scribe">
                    Scribe
                </label>
            </div>
        </div>

        <button type="submit" class="btn btn-primary px-4">شروع</button>
    </form>
</div>

<!-- ===============================
     IMPORT FROM URL
================================ -->
<div class="card-clean p-4 mb-4">
    <h5 class="mb-3">Import از لینک</h5>

    <div class="input-group">
        <input type="url" id="import-url" class="form-control"
               placeholder="https://example.com/page-with-audio">
        <button class="btn btn-outline-primary" type="button" onclick="startImport()">
            بررسی لینک
        </button>
    </div>

    <div id="import-status" class="mt-3 text-muted"></div>
    <div id="import-preview" class="mt-3"></div>
</div>





<div id="file-table-container">
    {% include "partials/file_table_container.html" %}
</div>

<script>

    function getCSRFToken() {
    const name = "csrftoken=";
    const decodedCookie = decodeURIComponent(document.cookie);
    const parts = decodedCookie.split(';');
    for (let i = 0; i < parts.length; i++) {
        let c = parts[i].trim();
        if (c.startsWith(name)) {
            return c.substring(name.length);
        }
    }
    return "";
}




/* ==========================================
   UPLOAD REFRESH WARNING (GLOBAL)
========================================== */
let uploadInProgress = false;

function markUploadStart() {
    uploadInProgress = true;
}

function markUploadEnd() {
    uploadInProgress = false;
}

window.addEventListener("beforeunload", function (e) {
    if (!uploadInProgress) return;
    e.preventDefault();
    e.returnValue = "";
});

/* ==========================================
   TEMP ROW (SKELETON)
========================================== */
function createSkeletonTempRow(tempId) {
    return `
<tr id="${tempId}" class="temp-row" data-temp-upload="1">
    <td style="width:32%;">
        <div class="skeleton" style="height:18px; width:60%; margin-bottom:6px;"></div>
        <div class="skeleton" style="height:14px; width:40%; margin-bottom:6px;"></div>
        <div class="skeleton" style="height:14px; width:30%;"></div>
    </td>

    <td style="width:18%; position:relative;">
        <div class="skeleton" style="height:18px; width:70%; margin-bottom:10px;"></div>

        <div style="position:absolute; top:0; left:0; right:0;
                    color:var(--text); font-weight:bold; font-size:14px;">
            در حال آپلود...
        </div>

        <div class="progress mt-2" style="height:6px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated upload-progress-bar"
                 style="width:0%; background-color:#ffcc00;"></div>
        </div>

        <small class="upload-status-text" style="opacity:.7;">0%</small>
    </td>

    <td style="width:34%;">
        <div class="skeleton" style="height:16px; width:80%; margin-bottom:6px;"></div>
        <div class="skeleton" style="height:16px; width:60%;"></div>
    </td>

    <td style="width:16%;">
        <div class="skeleton" style="height:32px; width:70%;"></div>
    </td>
</tr>`;
}

/* ==========================================
   UPLOAD HANDLER (FIXED)
========================================== */
document.getElementById("upload-form").addEventListener("submit", function (e) {
    e.preventDefault();

    const fileInput = document.getElementById("audio-file");
    if (!fileInput.files.length) return;

    const tbody = document.getElementById("file-list-tbody");
    const tempId = "temp-" + Date.now();

    tbody.insertAdjacentHTML("afterbegin", createSkeletonTempRow(tempId));

    document.getElementById("file-table-container").scrollIntoView({ 
        behavior: "smooth", 
        block: "start" 
    });

    const emptyRow = document.getElementById("empty-row");
    if (emptyRow) emptyRow.remove();

    const formData = new FormData(this);
    const xhr = new XMLHttpRequest();

    /*  IMPORTANT */
    markUploadStart();

    xhr.open("POST", "{% url 'upload_file' %}");

    xhr.upload.onprogress = function (e) {
        if (!e.lengthComputable) return;

        const percent = Math.round((e.loaded / e.total) * 100);
        const bar = document.querySelector(`#${tempId} .upload-progress-bar`);
        const text = document.querySelector(`#${tempId} .upload-status-text`);

        if (bar) bar.style.width = percent + "%";
        if (text) text.textContent = percent + "%";
    };

    xhr.onload = function () {
        markUploadEnd();

        const tr = document.getElementById(tempId);

        if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            const fileId = data.file_id;

            fetch("{% url 'update_row' 0 %}".replace("0", fileId))
                .then(r => r.text())
                .then(html => {
                    if (tr) tr.outerHTML = html;
                });

            document.getElementById("upload-form").reset();
        } else {
            if (tr) tr.remove();
            alert("خطا در آپلود");
        }
    };

    xhr.onerror = xhr.onabort = function () {
        markUploadEnd();
        const tr = document.getElementById(tempId);
        if (tr) tr.remove();
        alert("آپلود قطع شد");
    };

    xhr.send(formData);
});

/* ==========================================
   AJAX Pagination
========================================== */
let isFetchingFiles = false;

function fetchFiles(page = 1) {
    if (isFetchingFiles) return;
    isFetchingFiles = true;

    window.disableRowLock = true;

    fetch(`{% url 'get_files' %}?page=${page}`)
        .then(r => r.text())
        .then(html => {
            document.getElementById("file-table-container").innerHTML = html;
            history.replaceState({ page }, "", window.location.pathname);
        })
        .finally(() => {
            window.disableRowLock = false;
            isFetchingFiles = false;
        });
}

/* ==========================================
   ROW-LEVEL POLLING LOCK
========================================== */
const lockedRows = new Set();

document.addEventListener("mouseover", e => {
    if (window.disableRowLock) return;
    const el = e.target.closest("[data-lock-refresh='true']");
    if (!el) return;
    lockedRows.add(el.dataset.fileId);
});

document.addEventListener("mouseout", e => {
    const el = e.target.closest("[data-lock-refresh='true']");
    if (!el) return;
    lockedRows.delete(el.dataset.fileId);
});

/* ==========================================
   Polling (Row-by-Row, Safe)
========================================== */
let pollingLocked = false;

function pollRows() {
    if (pollingLocked) return;
    pollingLocked = true;

    document.querySelectorAll("tr[data-file-id]").forEach(row => {
        if (row.dataset.tempUpload === "1") return;

        const fileId = row.dataset.fileId;
        if (lockedRows.has(fileId)) return;

        fetch("{% url 'update_row' 0 %}".replace("0", fileId))
            .then(r => r.text())
            .then(html => {
                const current = document.getElementById("row-" + fileId);
                if (current) current.outerHTML = html;
            });
    });

    pollingLocked = false;
}

setInterval(pollRows, 3000);

/* ==========================================
   Delete File
========================================== */
document.addEventListener("click", function (e) {
    if (!e.target.matches(".btn-delete-file")) return;

    const id = e.target.dataset.id;
    if (!confirm("آیا حذف شود؟")) return;

    fetch("{% url 'delete_file' 0 %}".replace("0", id), {
        method: "DELETE",
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
    })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                const row = document.getElementById("row-" + id);
                if (row) row.remove();
            }
        });
});

/* ==========================================
   Pagination Click
========================================== */
document.addEventListener("click", function (e) {
    if (!e.target.classList.contains("page-link")) return;
    e.preventDefault();

    const page = e.target.dataset.page;
    if (page) fetchFiles(page);
});



/* ==========================================
   IMPORT URL (MINIMAL ADDON)
========================================== */

let importBatchId = null;
let importPollTimer = null;

window.startImport = function (){
    const urlInput = document.getElementById("import-url");
    const statusBox = document.getElementById("import-status");
    const previewBox = document.getElementById("import-preview");

    const url = urlInput.value.trim();
    if (!url) {
        alert("لینک را وارد کنید");
        return;
    }

    statusBox.textContent = "در حال بررسی لینک...";
    previewBox.innerHTML = "";

    const form = new FormData();
    form.append("url", url);

    fetch("{% url 'create_import_batch' %}", {
        method: "POST",
        body: form,
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        }
    })
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                statusBox.textContent = data.error || "خطا";
                return;
            }

            importBatchId = data.batch_id;
            importPollTimer = setInterval(checkImportStatus, 2000);
        });
}

function checkImportStatus() {
    if (!importBatchId) return;

    fetch("{% url 'import_batch_status' 0 %}".replace("0", importBatchId))
        .then(r => r.json())
        .then(data => {
            if (data.status === "DISCOVERING") {
                document.getElementById("import-status").textContent =
                    "در حال استخراج فایل‌ها...";
            }

            if (data.status === "READY") {
                clearInterval(importPollTimer);
                document.getElementById("import-status").textContent =
                    "فایل‌ها را انتخاب کنید";
                document.getElementById("import-preview").innerHTML = data.html;
            }

            if (data.status === "FAILED") {
                clearInterval(importPollTimer);
                document.getElementById("import-status").textContent =
                    data.error || "خطا در بررسی لینک";
            }
        });
}

/* ==========================================
   ENQUEUE SELECTED IMPORT ITEMS
========================================== */
window.enqueueSelected = function (batchId) {

    const selected = Array.from(
        document.querySelectorAll('.import-item-checkbox:checked')
    ).map(cb => cb.value);

    if (selected.length === 0) {
        alert("حداقل یک فایل را انتخاب کنید");
        return;
    }


    let modelInput = document.querySelector('input[name="import_model_name"]:checked');
    

    if (!modelInput) {
 
         modelInput = document.querySelector('input[name="model_name"]:checked');
    }

    const modelName = modelInput?.value;

    if (!modelName) {
        alert("مدل پردازش را انتخاب کنید");
        return;
    }
    
    console.log("Selected Model for Import:", modelName); 

    fetch("/import/enqueue/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({
            items: selected,
            batch_id: batchId,     
            model_name: modelName  
        })
    })
    .then(res => res.json())
    .then(data => {
        if (!data.success) {
            alert(data.error || "خطا در شروع پردازش");
            return;
        }

        window.location.href = window.location.pathname + "?t=" + Date.now() + "#file-table-container"; 
    })
    .catch(err => {
        console.error(err);
        alert("خطای ارتباط با سرور");
    });

};




</script>




{% endblock %}
